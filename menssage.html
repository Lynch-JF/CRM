<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Menssage</title>
<link rel="stylesheet" href="CSS/style.css">

<style>
/* ================= VARIABLES ================= */
:root{
    --primary:#6366f1;
    --primary-dark:#4f46e5;
    --accent:#06b6d4;
    --success:#22c55e;
    --bg:#f3f4f6;
    --sidebar:#0f172a;
    --white:#ffffff;
    --gray:#94a3b8;
}

/* ================= RESET ================= */
*{
    margin:0;
    padding:0;
    box-sizing:border-box;
    font-family:'Segoe UI', sans-serif;
}

body{
    background:linear-gradient(135deg,#eef2ff,#f8fafc);
    height:100vh;
    overflow:hidden;
}

/* ================= CONTENEDOR ================= */
.crm-container{
    display:flex;
    height:100vh;
}

/* ================= SIDEBAR ================= */
.sidebar{
    width:280px;
    background:linear-gradient(180deg,#0f172a,#1e293b);
    color:white;
    display:flex;
    flex-direction:column;
    border-right:1px solid rgba(255,255,255,.05);
    transition:.3s ease;
}

.logo-area{
    padding:20px;
    text-align:center;
    border-bottom:1px solid rgba(255,255,255,.05);
}

.logo-area img{
    width:75%;
}

.header-search{
    display:flex;
    padding:15px;
    gap:8px;
}

.header-search input{
    flex:1;
    padding:10px;
    border-radius:8px;
    border:none;
    outline:none;
}

.search-btn{
    background:linear-gradient(135deg,var(--primary),var(--accent));
    border:none;
    color:white;
    padding:10px 14px;
    border-radius:8px;
    cursor:pointer;
    box-shadow:0 4px 15px rgba(99,102,241,.4);
}

/* ================= CONTACTOS ================= */
.contact-list{
    list-style:none;
    overflow-y:auto;
    flex:1;
}

.contact-list li{
    padding:15px;
    cursor:pointer;
    border-bottom:1px solid rgba(255,255,255,.05);
    transition:.25s ease;
}

.contact-list li:hover{
    background:rgba(99,102,241,.15);
    transform:translateX(5px);
}

.contact-list li.active{
    background:rgba(99,102,241,.25);
}

.contact-list li.unread::after{
    content:"";
    width:10px;
    height:10px;
    background:var(--success);
    border-radius:50%;
    position:absolute;
    right:15px;
    top:50%;
    transform:translateY(-50%);
}

.contact-list li span{
    display:block;
    font-size:12px;
    opacity:.6;
    margin-top:5px;
}

/* ================= CHAT ================= */
.chat-area{
    flex:1;
    display:flex;
    flex-direction:column;
    background:#f9fafb;
    position:relative;
}

.chat-header{
    padding:15px 20px;
    background:white;
    border-bottom:1px solid #e5e7eb;
    font-weight:600;
    display:flex;
    align-items:center;
    gap:10px;
}

.status{
    width:8px;
    height:8px;
    border-radius:50%;
    background:var(--success);
}

/* ================= MENSAJES ================= */
.messages-container{
    flex:1;
    padding:20px;
    overflow-y:auto;
    display:flex;
    flex-direction:column;
    gap:12px;
    transition:.2s ease;
}

.message{
    max-width:60%;
    padding:12px 15px;
    border-radius:14px;
    font-size:14px;
    opacity:0;
    transform:translateY(15px) scale(.95);
    animation:messageIn .3s ease forwards;
}

@keyframes messageIn{
    to{
        opacity:1;
        transform:translateY(0) scale(1);
    }
}

.message.sent{
    align-self:flex-end;
    background:linear-gradient(135deg,var(--primary),var(--accent));
    color:white;
    box-shadow:0 4px 12px rgba(99,102,241,.3);
}

.message.received{
    align-self:flex-start;
    background:white;
    border:1px solid #e5e7eb;
    box-shadow:0 2px 6px rgba(0,0,0,.05);
}

.message small{
    display:block;
    font-size:10px;
    margin-top:6px;
    opacity:.7;
}

/* ================= INPUT ================= */
.input-area{
    position:absolute;
    bottom:0;
    left:0;
    width:100%;
    background:white;
    padding:15px;
    display:flex;
    gap:10px;
    border-top:1px solid #e5e7eb;
}

.input-area input{
    flex:1;
    padding:12px;
    border-radius:10px;
    border:1px solid #d1d5db;
    outline:none;
}

.input-area button{
    background:linear-gradient(135deg,var(--primary),var(--accent));
    color:white;
    border:none;
    padding:12px 20px;
    border-radius:10px;
    cursor:pointer;
    transition:.2s;
}

.input-area button:hover{
    transform:scale(1.05);
}

/* ================= PANEL DERECHO ================= */
.details-panel{
    width:300px;
    background:white;
    border-left:1px solid #e5e7eb;
    padding:20px;
    display:flex;
    flex-direction:column;
    gap:15px;
    transition:.3s ease;
}

.client-card{
    backdrop-filter:blur(10px);
    background:rgba(255,255,255,.8);
    padding:15px;
    border-radius:12px;
    border:1px solid #e5e7eb;
    box-shadow:0 8px 20px rgba(0,0,0,.05);
}

.client-card input,
.client-card textarea{
    width:100%;
    padding:8px;
    margin-top:5px;
    margin-bottom:10px;
    border-radius:8px;
    border:1px solid #d1d5db;
}

/* ================= SCROLL ================= */
::-webkit-scrollbar{
    width:6px;
}
::-webkit-scrollbar-thumb{
    background:var(--primary);
    border-radius:10px;
}

/* ================= RESPONSIVE ================= */
/* ================= MOBILE FIRST FIX ================= */

@media (max-width: 768px){

    body{
        overflow:auto;
    }

    .crm-container{
        flex-direction:column;
        height:auto;
        min-height:100vh;
    }

    /* SIDEBAR ocupa toda la pantalla al inicio */
    .sidebar{
        width:100%;
        height:100vh;
    }

    /* CHAT oculto por defecto */
    .chat-area{
    flex:1;
    display:flex;
    flex-direction:column;
    background:#f9fafb;
    height:100vh;
    position:relative;
}

    .chat-area.active{
        left:0;
    }

    /* PANEL DERECHO oculto completamente */
    .details-panel{
        display:none !important;
    }

    .messages-container{
    flex:1;
    padding:20px;
    padding-bottom:90px; /* espacio para el input */
    overflow-y:auto;
    display:flex;
    flex-direction:column;
    gap:12px;
}

    .message{
        max-width:85%;
    }

    .logo-area{
        padding:30px 20px;
    }
}

.hidden{display:none !important;}
</style>

</head>

<body>

<div class="crm-container">

<!-- ================= SIDEBAR ================= -->
<aside class="sidebar">

<div class="logo-area">
<img src="img/logo2actualizado.png" class="logo" style="width:80%;">
</div>

<div class="header-search">
<input type="text" placeholder="Buscar cliente...">
<button class="search-btn">üîç</button>
</div>

<ul class="contact-list" id="contactList">

<li data-id="1">
<strong>Juan P√©rez</strong>
<span>Hola, ¬øtienen stock?</span>
</li>

<li data-id="2">
<strong>Mar√≠a Garc√≠a</strong>
<span>Gracias por la info.</span>
</li>

</ul>

</aside>

<!-- ================= CHAT ================= -->
<main class="chat-area">

<header class="chat-header hidden">
<button id="backBtn" style="background:none;border:none;font-size:18px;cursor:pointer;">‚Üê</button>
<h3>Bandeja de mensajes</h3>
<span class="status"></span>
</header>

<div class="messages-container" id="chatWindow">

<!-- estado vac√≠o -->
<div class="empty-state" id="emptyState">
<img src="img/logo2actualizado.png" style="width:300px;">
<h3>Selecciona un chat</h3>
<p>Tu bandeja est√° lista</p>
</div>

</div>

<form class="input-area hidden" id="chatForm">
<input type="text" id="msgInput" placeholder="Escribe un mensaje..." autocomplete="off">
<button type="submit">Enviar</button>
</form>

</main>

<!-- ================= PANEL CLIENTE ================= -->
<aside class="details-panel hidden">

<h3>Cliente</h3>

<div class="client-card">
<h4>Informaci√≥n b√°sica</h4>
<p><strong>Nombre:</strong> <span id="clientName"></span></p>
<p><strong>Email:</strong> <span id="clientEmail"></span></p>
</div>

<div class="client-card">
<h4>Datos adicionales</h4>

<label>Tel√©fono</label>
<input id="clientPhone">

<label>Ciudad</label>
<input id="clientCity">

<label>Notas</label>
<textarea id="clientNotes"></textarea>
</div>

<div class="client-card actions">
<button class="btn help">Ayuda</button>
<button class="btn close" id="closeChat">Cerrar chat</button>
</div>

</aside>

</div>

<script>
// ================= CONFIGURACI√ìN BACKEND =================
const API_BASE_URL = "https://localhost:7217/api";
const EMPRESA_ID = "empresa1";

// ================= VARIABLES =================
let activeChatId = null;
const backBtn = document.getElementById("backBtn");
const headerUI = document.querySelector(".chat-header");
const inputUI = document.querySelector(".input-area");
const detailsUI = document.querySelector(".details-panel");

const clientName = document.getElementById("clientName");
const clientEmail = document.getElementById("clientEmail");
const clientPhone = document.getElementById("clientPhone");
const clientCity = document.getElementById("clientCity");
const clientNotes = document.getElementById("clientNotes");

const chatWindow = document.getElementById("chatWindow");
const chatHeader = document.querySelector(".chat-header h3");

// ================= CARGAR CLIENTE =================
function loadClientDetails(id) {
    clientName.textContent = "Cliente " + id;
    clientEmail.textContent = "cliente" + id + "@empresa.com";
    clientPhone.textContent = "809-000-000" + id;
    clientCity.textContent = "Jarabacoa";
    clientNotes.textContent = "Cliente activo";
}

// ================= CARGAR CHAT =================
function loadChat(id) {

    activeChatId = id;

    const emptyState = document.getElementById("emptyState");
    if (emptyState) emptyState.remove();

    chatHeader.innerHTML = `Cliente ${id} <span class="status online"></span>`;

    headerUI.classList.remove("hidden");
    inputUI.classList.remove("hidden");
    detailsUI.classList.remove("hidden");

    fetchMessages(id);
    loadClientDetails(id);

    // Quitar estado activo a todos
    document.querySelectorAll('.contact-list li')
        .forEach(li => li.classList.remove('active'));

    // Activar el seleccionado y quitar unread
    const activeLi = document.querySelector(`[data-id="${id}"]`);

    if (activeLi) {
        activeLi.classList.add('active');
        activeLi.classList.remove('unread');
    }
if(window.innerWidth <= 768){
    document.querySelector(".chat-area").classList.add("active");
}
backBtn.addEventListener("click",()=>{
    document.querySelector(".chat-area").classList.remove("active");
});
  }

// ================= RESET =================
function resetChatUI() {

    activeChatId = null;

    chatWindow.innerHTML = `
        <div class="empty-state" id="emptyState">
            <h3>Selecciona un chat</h3>
            <p>Tu bandeja est√° lista</p>
        </div>
    `;

    headerUI.classList.add("hidden");
    inputUI.classList.add("hidden");
    detailsUI.classList.add("hidden");

    document.querySelectorAll(".contact-list li")
        .forEach(li => li.classList.remove("active"));
}

// ================= EVENTOS LISTA =================
document.querySelectorAll(".contact-list li")
    .forEach(item => {
        item.addEventListener("click", () => {
            loadChat(item.dataset.id);
        });
    });

// ================= RENDER MENSAJE =================
function renderMessage(text, type, time) {

    const msg = document.createElement("div");
    msg.className = `message ${type}`;

    const messageText = document.createElement("span");
    messageText.textContent = text;

    const messageTime = document.createElement("small");
    messageTime.textContent = time;

    msg.appendChild(messageText);
    msg.appendChild(messageTime);

    chatWindow.appendChild(msg);

    // Animaci√≥n tipo pop
    msg.style.transform = "scale(0.8)";
    msg.style.opacity = "0";

    setTimeout(() => {
        msg.style.transition = "0.2s ease";
        msg.style.transform = "scale(1)";
        msg.style.opacity = "1";
    }, 10);

    chatWindow.scrollTop = chatWindow.scrollHeight;
}

function markAsUnread(chatId){
    const li = document.querySelector(`[data-id="${chatId}"]`);
    if(li && chatId != activeChatId){
        li.classList.add("unread");
    }
}

// ================= FETCH MENSAJES =================
async function fetchMessages(chatId) {

    const url = `${API_BASE_URL}/${EMPRESA_ID}/messages/${chatId}`;

    try {

        console.log("GET:", url);

        const res = await fetch(url);

        if (!res.ok) {
            const errorText = await res.text();
            console.error("Backend error:", errorText);
            throw new Error("Error del servidor");
        }

        const data = await res.json();

        chatWindow.innerHTML = "";

        if (!Array.isArray(data) || data.length === 0) {
            chatWindow.innerHTML = `
                <div class="empty-state">
                    <p>No hay mensajes a√∫n</p>
                </div>
            `;
            return;
        }

        data.forEach(msg => {
            renderMessage(msg.text, msg.type, msg.time);
        });

    } catch (error) {
        console.error("Error cargando mensajes:", error);

        chatWindow.innerHTML = `
            <div class="empty-state">
                <p style="color:red;">No se pudo conectar al servidor</p>
            </div>
        `;
    }
}

// ================= ENVIAR MENSAJE =================
document.getElementById("chatForm")
    .addEventListener("submit", async (e) => {

        e.preventDefault();

        const input = document.getElementById("msgInput");
        const text = input.value.trim();

        if (!text || !activeChatId) return;

        const time = new Date().toLocaleTimeString([], {
            hour: "2-digit",
            minute: "2-digit"
        });

        const nuevoMsg = {
            text: text,
            type: "sent",
            time: time
        };

        // Render inmediato (optimista)
        renderMessage(text, "sent", time);
        input.value = "";

        const url = `${API_BASE_URL}/${EMPRESA_ID}/messages/${activeChatId}`;

        try {

            console.log("POST:", url);

            const res = await fetch(url, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(nuevoMsg)
            });

            if (!res.ok) {
                const errorText = await res.text();
                console.error("Backend error:", errorText);
                throw new Error("No se pudo guardar");
            }

            console.log("Mensaje guardado correctamente");

        } catch (error) {

            console.error("Error enviando mensaje:", error);

            alert("No se pudo enviar el mensaje al servidor");
        }
    });

// ================= CERRAR CHAT =================
document.getElementById("closeChat")
    .addEventListener("click", resetChatUI);


// üî• CAMBIA ESTE VALOR PARA CONTROLAR CADA CU√ÅNTOS SEGUNDOS LLEGA UN MENSAJE
const MESSAGE_INTERVAL_MS = 5000; // 5000 = 5 segundos

setInterval(() => {

    // Simulamos que llega mensaje a un chat aleatorio (1 o 2)
    const randomChatId = Math.random() > 0.5 ? "1" : "2";

    const time = new Date().toLocaleTimeString([], {
        hour: "2-digit",
        minute: "2-digit"
    });

    const incomingMessage = {
        text: "Mensaje nuevo del cliente " + randomChatId,
        type: "received",
        time: time
    };

    console.log("Mensaje simulado desde backend:", incomingMessage);

    // Si el chat est√° abierto ‚Üí render directo
    if (activeChatId === randomChatId) {

        renderMessage(
            incomingMessage.text,
            incomingMessage.type,
            incomingMessage.time
        );

    } else {

        // Si NO est√° abierto ‚Üí marcar como no le√≠do
        markAsUnread(randomChatId);

    }

}, MESSAGE_INTERVAL_MS);

</script>

</body>
</html>
