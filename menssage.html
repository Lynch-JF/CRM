<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Menssage</title>
<link rel="stylesheet" href="CSS/style.css">

<style>
  /* ===============================
   RESET + THEME
=============================== */

* {
  box-sizing: border-box;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  margin: 0;
  height: 100vh;
  overflow: hidden;
  background: linear-gradient(135deg, #1e3c72, #2a5298);
}

/* Scroll elegante */

::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-thumb {
  background: rgba(0,0,0,0.25);
  border-radius: 10px;
}

/* ===============================
   LAYOUT PRINCIPAL
=============================== */

.crm-container {
  display: flex;
  height: 100%;
  backdrop-filter: blur(10px);
}

/* ===============================
   SIDE PANELS
=============================== */

.sidebar,
.details-panel {
  width: 300px;
  background: rgba(255,255,255,0.92);
  border: none;
  display: flex;
  flex-direction: column;
  transition: all 0.3s ease;
  animation: fadeSlide 0.5s ease;
}

.details-panel {
  padding: 20px;
  box-shadow: -5px 0 20px rgba(0,0,0,0.08);
}

.sidebar {
  box-shadow: 5px 0 20px rgba(0,0,0,0.08);
}

/* ===============================
   CONTACT LIST
=============================== */

.contact-list {
  list-style: none;
  padding: 0;
  margin: 0;
  overflow-y: auto;
}

.contact-list li {
  padding: 15px;
  border-bottom: 1px solid rgba(0,0,0,0.05);
  cursor: pointer;
  transition: all 0.25s ease;
  position: relative;
}

.contact-list li:hover {
  background: linear-gradient(90deg, rgba(42,82,152,0.08), transparent);
  transform: translateX(5px);
}

.contact-list li.active {
  background: linear-gradient(90deg, #2a5298, #1e3c72);
  color: white;
}

.contact-list li strong {
  display: block;
}

.contact-list li span {
  font-size: 0.85em;
  opacity: 0.7;
}

/* ===============================
   CHAT AREA
=============================== */

.chat-area {
  flex-grow: 1;
  display: flex;
  flex-direction: column;
  background: linear-gradient(180deg, #eef3ff, #dbe6ff);
  position: relative;
}

/* Header */

.chat-header {
  padding: 15px 20px;
  background: rgba(255,255,255,0.9);
  backdrop-filter: blur(6px);
  font-weight: bold;
  box-shadow: 0 2px 10px rgba(0,0,0,0.08);
}

/* Messages */

.messages-container {
  flex-grow: 1;
  padding: 20px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

/* ===============================
   MESSAGE BUBBLES
=============================== */

.message {
  max-width: 70%;
  padding: 10px 15px;
  border-radius: 12px;
  font-size: 0.95em;
  position: relative;
  animation: bubblePop 0.25s ease;
  box-shadow: 0 3px 6px rgba(0,0,0,0.08);
}

.message small {
  display: block;
  font-size: 0.7em;
  margin-top: 5px;
  opacity: 0.6;
  text-align: right;
}

.sent {
  align-self: flex-end;
  background: linear-gradient(135deg, #2a5298, #1e3c72);
  color: white;
}

.received {
  align-self: flex-start;
  background: white;
}

/* ===============================
   INPUT AREA
=============================== */

.input-area {
  padding: 12px;
  background: rgba(255,255,255,0.9);
  display: flex;
  gap: 10px;
  backdrop-filter: blur(6px);
}

.input-area input {
  flex-grow: 1;
  padding: 12px 15px;
  border-radius: 25px;
  border: none;
  outline: none;
  background: #f1f3f8;
  transition: all 0.2s ease;
}

.input-area input:focus {
  background: white;
  box-shadow: 0 0 0 2px rgba(42,82,152,0.3);
}

/* ===============================
   ANIMATIONS
=============================== */

@keyframes fadeSlide {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
}

@keyframes bubblePop {
  from {
    opacity: 0;
    transform: scale(0.8);
  }
}

/* ===============================
   RESPONSIVE MASTER SYSTEM
=============================== */

/* Tablets */

@media (max-width: 1024px) {
  .details-panel {
    display: none;
  }
}

/* Mobile layout */

@media (max-width: 768px) {

  .crm-container {
    position: relative;
  }

  .sidebar {
    width: 100%;
    position: absolute;
    height: 100%;
    z-index: 2;
  }

  .chat-area {
    position: absolute;
    width: 100%;
    height: 100%;
    left: 100%;
    transition: left 0.35s ease;
    z-index: 3;
  }

  .crm-container.view-chat .chat-area {
    left: 0;
  }
}

/* Extra small devices */

@media (max-width: 480px) {

  .message {
    max-width: 85%;
    font-size: 0.9em;
  }

  .input-area input {
    font-size: 0.9em;
  }
}

/* Logo */

.logo-area {
  padding: 20px;
  font-weight: bold;
  text-align: center;
  border-bottom: 1px solid rgba(0,0,0,0.08);
}

/* Buscador */

.header-search {
  display: flex;
  padding: 12px;
  gap: 8px;
}

.header-search input {
  flex: 1;
  padding: 10px;
  border-radius: 20px;
  border: none;
  background: #f1f3f8;
}

.search-btn {
  border: none;
  border-radius: 50%;
  width: 38px;
  cursor: pointer;
  background: #2a5298;
  color: white;
  font-size: 16px;
}

/* Cards cliente */

.client-card {
  background: white;
  border-radius: 10px;
  padding: 15px;
  margin-bottom: 15px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.08);
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.client-card h4 {
  margin: 0 0 5px 0;
  font-size: 0.95em;
  color: #2a5298;
}

.client-card input,
.client-card textarea {
  padding: 8px;
  border-radius: 6px;
  border: 1px solid #ddd;
}

.client-card textarea {
  resize: none;
  height: 60px;
}

/* Botones */

.client-card.actions {
  flex-direction: row;
  justify-content: space-between;
}

.btn {
  flex: 1;
  padding: 10px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
}

.btn.help {
  background: #2a5298;
  color: white;
  margin-right: 5px;
}

.btn.close {
  background: #eee;
}

.empty-state{
display:flex;
flex-direction:column;
justify-content:center;
align-items:center;
height:100%;
text-align:center;
color:#777;
}

.empty-state img{
width:140px;
opacity:.8;
margin-bottom:15px;
}

.messages-container{
position:relative;
}
.hidden{ display:none !important; }
</style>

</head>

<body>

<div class="crm-container">

<!-- ================= SIDEBAR ================= -->
<aside class="sidebar">

<div class="logo-area">
<img src="img/logo2actualizado.png" class="logo" style="width:80%;">
</div>

<div class="header-search">
<input type="text" placeholder="Buscar cliente...">
<button class="search-btn">üîç</button>
</div>

<ul class="contact-list" id="contactList">

<li data-id="1">
<strong>Juan P√©rez</strong>
<span>Hola, ¬øtienen stock?</span>
</li>

<li data-id="2">
<strong>Mar√≠a Garc√≠a</strong>
<span>Gracias por la info.</span>
</li>

</ul>

</aside>

<!-- ================= CHAT ================= -->
<main class="chat-area">

<header class="chat-header hidden">
<h3>Bandeja de mensajes</h3>
</header>

<div class="messages-container" id="chatWindow">

<!-- estado vac√≠o -->
<div class="empty-state" id="emptyState">
<img src="img/logo2actualizado.png" style="width:300px;">
<h3>Selecciona un chat</h3>
<p>Tu bandeja est√° lista</p>
</div>

</div>

<form class="input-area hidden" id="chatForm">
<input type="text" id="msgInput" placeholder="Escribe un mensaje..." autocomplete="off">
<button type="submit">Enviar</button>
</form>

</main>

<!-- ================= PANEL CLIENTE ================= -->
<aside class="details-panel hidden">

<h3>Cliente</h3>

<div class="client-card">
<h4>Informaci√≥n b√°sica</h4>
<p><strong>Nombre:</strong> <span id="clientName"></span></p>
<p><strong>Email:</strong> <span id="clientEmail"></span></p>
</div>

<div class="client-card">
<h4>Datos adicionales</h4>

<label>Tel√©fono</label>
<input id="clientPhone">

<label>Ciudad</label>
<input id="clientCity">

<label>Notas</label>
<textarea id="clientNotes"></textarea>
</div>

<div class="client-card actions">
<button class="btn help">Ayuda</button>
<button class="btn close" id="closeChat">Cerrar chat</button>
</div>

</aside>

</div>

<script>

// ================= BASE SIMULADA =================

const chatData = {

1:{
name:"Juan P√©rez",
email:"juan@ejemplo.com",
phone:"",
city:"",
notes:"",
messages:[
{ text:"Hola, ¬øtienen stock?", type:"received", time:"10:00" }
]
},

2:{
name:"Mar√≠a Garc√≠a",
email:"maria@ejemplo.com",
phone:"",
city:"",
notes:"",
messages:[
{ text:"Gracias por la info.", type:"sent", time:"09:15" }
]
}

};

// ================= VARIABLES =================

let activeChatId = null;

const headerUI = document.querySelector(".chat-header");
const inputUI = document.querySelector(".input-area");
const detailsUI = document.querySelector(".details-panel");

const clientName = document.getElementById("clientName");
const clientEmail = document.getElementById("clientEmail");
const clientPhone = document.getElementById("clientPhone");
const clientCity = document.getElementById("clientCity");
const clientNotes = document.getElementById("clientNotes");

const chatWindow = document.getElementById("chatWindow");
const chatHeader = document.querySelector(".chat-header h3");


// ================= CARGAR CLIENTE =================

function loadClientDetails(id){

const c = chatData[id];

clientName.textContent = c.name;
clientEmail.textContent = c.email;
clientPhone.value = c.phone;
clientCity.value = c.city;
clientNotes.value = c.notes;

}


// ================= CARGAR CHAT =================

// ================= CARGAR CHAT (CORREGIDO) =================
function loadChat(id) {
  activeChatId = id; // Aqu√≠ id es "1" o "2"
  const data = chatData[id];

  // Eliminamos el estado vac√≠o
  const emptyState = document.getElementById("emptyState");
  if (emptyState) emptyState.remove();

  // Actualizamos el t√≠tulo del chat
  chatHeader.innerHTML = `${data.name} <span class="status online"></span>`;

  // LLAMADA CLAVE: Usamos el ID directamente para el backend
  fetchMessages(id); 

  loadClientDetails(id);

  // Clase activa en la lista
  document.querySelectorAll('.contact-list li').forEach(li => li.classList.remove('active'));
  const activeLi = document.querySelector(`[data-id="${id}"]`);
  if (activeLi) activeLi.classList.add('active');
}


function resetChatUI(){

activeChatId = null;

// limpiar mensajes
chatWindow.innerHTML = `
<div class="empty-state" id="emptyState">
<img src="img/logo2.png" style="width:120px;">
<h3>Selecciona un chat</h3>
<p>Tu bandeja est√° lista</p>
</div>
`;

// ocultar UI
headerUI.classList.add("hidden");
inputUI.classList.add("hidden");
detailsUI.classList.add("hidden");

// limpiar selecci√≥n visual
document.querySelectorAll(".contact-list li")
.forEach(li=>li.classList.remove("active"));

// borrar sesi√≥n
localStorage.removeItem("activeChat");

}


// ================= EVENTOS =================

document.querySelectorAll(".contact-list li")
.forEach(item=>{
item.addEventListener("click",()=>{
loadChat(item.dataset.id);
});
});


// ================= ENVIAR MENSAJE =================

document.getElementById("chatForm")
.addEventListener("submit",e=>{

e.preventDefault();

if(!activeChatId) return;

const input = document.getElementById("msgInput");
const text = input.value.trim();

if(!text) return;

const time = new Date().toLocaleTimeString([],{
hour:"2-digit",
minute:"2-digit"
});

chatData[activeChatId].messages.push({
text,
type:"sent",
time
});

renderMessage(text,"sent",time);

input.value="";

});


// ================= RENDER MENSAJE =================

function renderMessage(text,type,time){

const msg = document.createElement("div");

msg.className=`message ${type}`;
msg.innerHTML=`${text}<small>${time}</small>`;

chatWindow.appendChild(msg);

chatWindow.scrollTop = chatWindow.scrollHeight;

}


// ================= GUARDAR DATOS CLIENTE =================

[clientPhone,clientCity,clientNotes]
.forEach(input=>{

input.addEventListener("input",()=>{

if(!activeChatId) return;

const c = chatData[activeChatId];

c.phone = clientPhone.value;
c.city = clientCity.value;
c.notes = clientNotes.value;

});

});

const savedChat = localStorage.getItem("activeChat");

if(savedChat && chatData[savedChat]){
loadChat(savedChat);
}

document.getElementById("closeChat")
.addEventListener("click", resetChatUI);

// ================= FETCH MESSAGES =================
async function fetchMessages(chatId) {
    try {
        const res = await fetch(`http://localhost:3000/messages/${chatId}`);
        const data = await res.json();

        chatWindow.innerHTML = ""; 
        headerUI.classList.remove("hidden");
        inputUI.classList.remove("hidden");
        detailsUI.classList.remove("hidden");

        data.forEach(msg => {
            renderMessage(msg.text, msg.type, msg.time);
        });
    } catch (error) {
        console.error("Error cargando mensajes:", error);
        chatWindow.innerHTML = `<p style="color:red; padding:20px;">Error de conexi√≥n</p>`;
    }
}

document.getElementById("chatForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  
  const input = document.getElementById("msgInput");
  const text = input.value.trim();
  
  if(!text || !activeChatId) return;

  const time = new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
  const nuevoMsg = { text: text, type: "sent", time: time };

  // 1. Lo dibujamos en la pantalla de inmediato
  renderMessage(text, "sent", time);
  input.value = "";

  // 2. Lo mandamos al servidor para que se guarde
  try {
    await fetch(`http://localhost:3000/messages/${activeChatId}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(nuevoMsg)
    });
    console.log("Mensaje guardado en el servidor");
  } catch (error) {
    console.error("Error al guardar:", error);
  }
});




</script>

</body>
</html>
